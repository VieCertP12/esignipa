<!DOCTYPE html>
<html dir="ltr" lang="vi" class="">
<!--[ <head> Open ]-->
<head>
    <!--[ Homepage title ]-->
    <title>Link4Sub - Link Unlocker Premium</title>
    <meta name="csrf-token" content="xI86UdLoSyqRVPYARNVaGezjL6CI5tD8wH0VNnny">
    <!--[ Meta for browser ]-->
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="max-image-preview:large" name="robots">
    
    <!-- Tailwind CSS (Để hỗ trợ các thành phần chức năng) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Gốc của giao diện -->
    <link rel="stylesheet" href="https://link4sub.com/home/css/style.css?v=22025">
    <link rel="stylesheet" href="https://link4sub.com/css/stu.css">
    <link rel="stylesheet" href="https://link4sub.com/css/notyf.css">

    <style>
        /* Custom Styles để hòa hợp Logic cũ vào Giao diện mới */
        .stu_lv { display: none !important; }
        
        /* Đè style cho khung chứa chính để hiển thị nội dung của chúng ta */
        #stuCnt {
            min-height: 400px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            /* background: rgba(255, 255, 255, 0.95) !important; */
        }

        /* Ẩn các phần thừa của giao diện gốc nếu cần */
        .landing-page { background: #f7f7fc; }
        
        /* Hiệu ứng loading riêng */
        .my-loader { border-top-color: #ed143d; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utility classes */
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar cho list task */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>

<body class="oGrd bD onId onHm" id="mainCont" style="padding-right: 0px;">
    
    <div class="mainWrp">
        <!--[ Header section ]-->
        <header class="header stick" id="header">
            <div class="headCn">
                <div class="headIn secIn">
                    <div class="headD headL">
                        <div class="headN section" id="header-title">
                            <div class="widget Header" id="Header1">
                                <div class="headInnr">
                                    <h1 class="headH hasSub">
                                        <span class="headTtl">
                                            <span style="font-weight: 700">Link4Sub</span>
                                        </span>
                                        <span class="headSub" data-text=""></span>
                                    </h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!--[ Landing Page Content ]-->
        <div class="landing-page">
            <div class="section" id="lPage-Top">
                <div class="page-1">
                    <div class="bg"></div>
                    <div class="hero">
                        <div class="anim-elements">
                            <div class="anim-element"></div>
                            <div class="anim-element"></div>
                            <div class="anim-element"></div>
                            <div class="anim-element"></div>
                            <div class="anim-element"></div>
                        </div>
                        
                        <!-- KHUNG CHÍNH (Nơi Logic của chúng ta sẽ hiển thị) -->
                        <div class="landing-absolute" id="gStu">
                            <div class="stu_cnt" id="stuCnt">
                                <!-- Nội dung sẽ được Javascript inject vào đây -->
                                <div class="flex flex-col items-center justify-center h-full py-10">
                                    <div class="my-loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-4"></div>
                                    <p class="text-gray-500 font-semibold">Đang tải hệ thống...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Các phần phụ (Features, FAQ...) giữ nguyên để trang web trông đầy đủ -->
            <div class="section" id="lPage-Center">
                <div class="page-3" id="Featured">
                    <div class="landing-content">
                        <div class="titlex">
                            <h2>Tại sao nên sử dụng Link4Sub?</h2>
                            <span>Hệ thống mở khóa link chuyên nghiệp</span>
                        </div>
                        <ul class="featured">
                            <li><div class="featuredSc-content"><div class="featuredSc-title">An toàn</div><div class="content">100% không virus.</div></div></li>
                            <li><div class="featuredSc-content"><div class="featuredSc-title">Nhanh chóng</div><div class="content">Server Google mạnh mẽ.</div></div></li>
                            <li><div class="featuredSc-content"><div class="featuredSc-title">Miễn phí</div><div class="content">Sử dụng trọn đời.</div></div></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="secIn">
                <div class="cdtIn section" id="credit-widget">
                    <div class="widget HTML" id="HTML88">
                        <div class="fotCd">
                            <span class="credit">© <span id="getYear">2025</span><bdi> ‧ <a href="#">LINK4SUB.COM</a></bdi></span>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- SCRIPT LOGIC (Firebase + App) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, deleteDoc, updateDoc, increment, serverTimestamp, query, orderBy } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMYvnDTyzfBIAFTuB9VLPYN-YiFtNov6c", 
            authDomain: "linksubproject.firebaseapp.com",
            projectId: "linksubproject",
            storageBucket: "linksubproject.firebasestorage.app",
            messagingSenderId: "899237330148",
            appId: "1:899237330148:web:13bf3cf081f1cb9dc808f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        let currentTasks = []; 
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');
        const container = document.getElementById('stuCnt');

        // --- PLATFORM CONFIG ---
        const platformConfig = {
            youtube: { color: 'bg-red-600', hover: 'hover:bg-red-700', icon: 'fa-youtube', actions: [{ type: 'sub', label: 'Đăng ký (Subscribe)' }, { type: 'like', label: 'Like Video' }] },
            facebook: { color: 'bg-blue-700', hover: 'hover:bg-blue-800', icon: 'fa-facebook', actions: [{ type: 'follow', label: 'Follow Page' }] },
            tiktok: { color: 'bg-black', hover: 'hover:bg-gray-800', icon: 'fa-tiktok', actions: [{ type: 'follow', label: 'Follow TikTok' }] },
            discord: { color: 'bg-indigo-500', hover: 'hover:bg-indigo-600', icon: 'fa-discord', actions: [{ type: 'join', label: 'Join Discord' }] },
            telegram: { color: 'bg-sky-500', hover: 'hover:bg-sky-600', icon: 'fa-telegram', actions: [{ type: 'join', label: 'Join Channel' }] }
        };

        // ==============================================
        // MAIN ROUTER
        // ==============================================
        async function init() {
            if (linkId) {
                // --> USER MODE (Khách làm nhiệm vụ)
                await renderUserMode(linkId);
            } else {
                // --> ADMIN/BUILDER MODE (Tạo link)
                renderAuthCheck();
            }
        }
        init();

        // ==============================================
        // 1. LOGIC AUTH & BUILDER (ADMIN)
        // ==============================================
        function renderAuthCheck() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    renderBuilder();
                } else {
                    renderLogin();
                }
            });
        }

        function renderLogin() {
            container.innerHTML = `
                <div class="w-full max-w-sm mx-auto animate-fade-in">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Admin Login</h2>
                    <div class="space-y-4">
                        <input type="email" id="email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
                        <input type="password" id="password" placeholder="Mật khẩu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
                        <button id="btnLogin" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition shadow-lg">ĐĂNG NHẬP</button>
                    </div>
                    <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden-section"></p>
                </div>
            `;
            
            document.getElementById('btnLogin').onclick = async () => {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, e, p);
                    // Auth state change will trigger renderBuilder
                } catch (err) {
                    const errEl = document.getElementById('loginError');
                    errEl.innerText = "Lỗi: " + err.code;
                    errEl.classList.remove('hidden-section');
                }
            };
        }

        function renderBuilder() {
            // Giao diện tạo link (Builder)
            container.innerHTML = `
                <div class="w-full h-full flex flex-col animate-fade-in">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-wand-magic-sparkles text-red-500"></i> Tạo Link Mới</h2>
                        <button id="btnLogout" class="text-xs text-gray-500 hover:text-red-500 underline">Đăng xuất</button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2 mb-4" style="max-height: 60vh;">
                        <!-- Input Info -->
                        <div class="space-y-3 mb-6">
                            <input type="text" id="bTitle" class="w-full p-3 border rounded-lg focus:outline-none focus:border-red-500" placeholder="Tiêu đề (VD: Key Hack Blox Fruit)">
                            <input type="text" id="bDest" class="w-full p-3 border rounded-lg focus:outline-none focus:border-green-500 border-green-200 bg-green-50" placeholder="Link Đích (Google Drive...)">
                        </div>

                        <!-- Platform Tabs -->
                        <div class="grid grid-cols-5 gap-1 mb-4">
                            ${Object.keys(platformConfig).map(key => `
                                <button onclick="window.setPlatform('${key}')" class="p-2 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 transition flex justify-center items-center">
                                    <i class="fa-brands ${platformConfig[key].icon} text-lg"></i>
                                </button>
                            `).join('')}
                        </div>

                        <!-- Action Buttons Dynamic -->
                        <div id="actionArea" class="grid grid-cols-2 gap-2 mb-4 p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                            <p class="col-span-2 text-center text-xs text-gray-400">Chọn nền tảng ở trên để hiện nút</p>
                        </div>

                        <!-- Task List -->
                        <div id="bTaskList" class="space-y-2">
                            <!-- Tasks added appear here -->
                        </div>
                    </div>

                    <button id="btnCreate" class="w-full bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition">
                        TẠO LINK NGAY
                    </button>
                    
                    <div class="mt-4 pt-2 border-t text-center">
                         <button id="btnHistory" class="text-sm text-blue-500 hover:underline">Xem lịch sử link đã tạo</button>
                    </div>
                </div>

                <!-- Modal History (Hidden by default) -->
                <div id="historyModal" class="fixed inset-0 bg-black/50 z-50 hidden-section flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold">Lịch sử Link</h3>
                            <button onclick="document.getElementById('historyModal').classList.add('hidden-section')" class="text-gray-500 hover:text-black"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="p-4 overflow-y-auto flex-1 custom-scroll">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                                    <tr><th class="p-2">Tên</th><th class="p-2 text-center">View</th><th class="p-2 text-right">Action</th></tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Event Listeners
            document.getElementById('btnLogout').onclick = () => signOut(auth);
            
            window.setPlatform = (key) => {
                const conf = platformConfig[key];
                const area = document.getElementById('actionArea');
                area.innerHTML = conf.actions.map(act => `
                    <button onclick="window.addTask('${key}', '${act.type}', '${act.label}')" class="${conf.color} text-white py-2 px-3 rounded text-xs font-bold hover:opacity-90 truncate">
                        + ${act.label}
                    </button>
                `).join('');
            };

            window.addTask = (platform, type, label) => {
                currentTasks.push({ id: Date.now(), platform, type, label, url: '' });
                renderTaskItems();
            };

            window.removeTask = (idx) => {
                currentTasks.splice(idx, 1);
                renderTaskItems();
            };

            window.updateTaskUrl = (idx, val) => {
                currentTasks[idx].url = val;
            };

            document.getElementById('btnCreate').onclick = saveLink;
            document.getElementById('btnHistory').onclick = loadHistory;

            // Default platform
            window.setPlatform('youtube');
        }

        function renderTaskItems() {
            const list = document.getElementById('bTaskList');
            if (currentTasks.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 text-xs italic py-2">Chưa có nhiệm vụ nào.</p>`;
                return;
            }
            list.innerHTML = currentTasks.map((t, i) => `
                <div class="bg-white border rounded p-2 flex items-center gap-2 shadow-sm animate-fade-in">
                    <span class="${platformConfig[t.platform].color} text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shrink-0">
                        <i class="fa-brands ${platformConfig[t.platform].icon}"></i>
                    </span>
                    <div class="flex-1">
                        <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                            <span>${t.label}</span>
                            <button onclick="window.removeTask(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <input type="text" onchange="window.updateTaskUrl(${i}, this.value)" value="${t.url}" placeholder="Dán link nhiệm vụ vào đây..." class="w-full text-xs p-1.5 border rounded bg-gray-50 focus:bg-white outline-none">
                    </div>
                </div>
            `).join('');
        }

        async function saveLink() {
            const title = document.getElementById('bTitle').value;
            const dest = document.getElementById('bDest').value;
            
            if (!title || !dest) return alert("Thiếu tiêu đề hoặc link đích!");
            if (currentTasks.length === 0) return alert("Thêm ít nhất 1 nhiệm vụ!");
            if (currentTasks.some(t => !t.url)) return alert("Điền đủ link cho các nhiệm vụ!");

            const btn = document.getElementById('btnCreate');
            btn.innerText = "Đang lưu...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "links"), {
                    title, destUrl: dest, tasks: currentTasks, 
                    createdAt: serverTimestamp(), views: 0
                });
                alert("Tạo thành công!");
                currentTasks = [];
                renderBuilder(); // Reset UI
            } catch (e) {
                alert("Lỗi: " + e.message);
                btn.innerText = "TẠO LINK NGAY";
                btn.disabled = false;
            }
        }

        async function loadHistory() {
            const modal = document.getElementById('historyModal');
            const tbody = document.getElementById('historyBody');
            modal.classList.remove('hidden-section');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading...</td></tr>';

            const q = query(collection(db, "links"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            let html = '';
            snap.forEach(d => {
                const data = d.data();
                const link = `${window.location.origin}${window.location.pathname}?id=${d.id}`;
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">
                            <div class="font-medium text-gray-800 truncate w-32">${data.title}</div>
                            <div class="text-[10px] text-gray-400">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</div>
                        </td>
                        <td class="p-2 text-center text-xs font-bold">${data.views || 0}</td>
                        <td class="p-2 text-right">
                            <button onclick="navigator.clipboard.writeText('${link}'); alert('Đã copy!')" class="text-blue-500 p-1 hover:bg-blue-100 rounded"><i class="fa-regular fa-copy"></i></button>
                            <button onclick="window.delLink('${d.id}')" class="text-red-500 p-1 hover:bg-red-100 rounded"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html || '<tr><td colspan="3" class="text-center p-4 text-gray-400">Trống</td></tr>';
        }

        window.delLink = async (id) => {
            if(confirm("Xoá?")) {
                await deleteDoc(doc(db, "links", id));
                loadHistory(); // Reload table
            }
        }

        // ==============================================
        // 2. LOGIC USER (GUEST VIEW)
        // ==============================================
        let completedSet = new Set();
        let currentLinkData = null;

        async function renderUserMode(id) {
            try {
                const snap = await getDoc(doc(db, "links", id));
                if (!snap.exists()) {
                    container.innerHTML = `<div class="text-center text-red-500 py-10"><i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i><br>Link không tồn tại.</div>`;
                    return;
                }
                
                const data = snap.data();
                currentLinkData = data;
                updateDoc(doc(db, "links", id), { views: increment(1) }); // Count view

                // Render UI
                container.innerHTML = `
                    <div class="w-full animate-fade-in flex flex-col h-full">
                        <div class="text-center mb-6">
                            <h1 class="text-xl font-bold text-gray-800 uppercase tracking-wide border-b-2 border-red-500 inline-block pb-1">${data.title}</h1>
                            <p class="text-xs text-gray-500 mt-2">Hoàn thành các bước để mở khóa nội dung</p>
                        </div>

                        <div id="uTaskList" class="space-y-3 mb-6">
                            ${(data.tasks || []).map((t, i) => {
                                const p = platformConfig[t.platform] || { color: 'bg-gray-500', icon: 'fa-link' };
                                return `
                                    <div id="task-row-${i}" class="relative bg-white border border-gray-200 rounded-lg p-3 shadow-sm transition hover:shadow-md flex items-center justify-between group overflow-hidden">
                                        <div class="absolute left-0 top-0 bottom-0 w-1 ${p.color}"></div>
                                        <div class="flex items-center gap-3 pl-2 overflow-hidden">
                                            <div class="w-8 h-8 rounded-full ${p.color} text-white flex items-center justify-center shrink-0 shadow-sm">
                                                <i class="fa-brands ${p.icon}"></i>
                                            </div>
                                            <div class="truncate">
                                                <div class="text-sm font-bold text-gray-700 truncate">${t.label}</div>
                                                <div class="text-[10px] text-gray-400">Nhấn để thực hiện</div>
                                            </div>
                                        </div>
                                        <button id="btn-do-${i}" onclick="window.doTask(${i}, '${t.url}')" class="ml-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-3 rounded-full transition whitespace-nowrap">
                                            THỰC HIỆN
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="mt-auto">
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                                <div id="uProgress" class="bg-green-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <a id="uUnlockBtn" href="#" onclick="return false;" class="block w-full bg-gray-300 text-gray-500 font-bold py-4 rounded-lg text-center cursor-not-allowed transition-all transform duration-300 shadow-none">
                                <i class="fa-solid fa-lock mr-2"></i> Đang bị khóa
                            </a>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-center text-red-500">Lỗi kết nối.</div>`;
            }
        }

        window.doTask = (idx, url) => {
            if (completedSet.has(idx)) return;
            
            // 1. Open Link
            window.open(url, '_blank');
            
            // 2. UI Wait state
            const btn = document.getElementById(`btn-do-${idx}`);
            let sec = 5; // Fake timer
            btn.disabled = true;
            btn.className = "ml-2 bg-yellow-100 text-yellow-600 text-xs font-bold py-2 px-3 rounded-full transition whitespace-nowrap";
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${sec}s`;

            const tmr = setInterval(() => {
                sec--;
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${sec}s`;
                if (sec <= 0) {
                    clearInterval(tmr);
                    completedSet.add(idx);
                    
                    // Done State
                    btn.className = "ml-2 bg-green-100 text-green-600 text-xs font-bold py-2 px-3 rounded-full transition whitespace-nowrap cursor-default";
                    btn.innerHTML = `<i class="fa-solid fa-check"></i>`;
                    document.getElementById(`task-row-${idx}`).classList.add('border-green-500', 'bg-green-50');
                    
                    checkUnlock();
                }
            }, 1000);
        };

        function checkUnlock() {
            const total = currentLinkData.tasks.length;
            const done = completedSet.size;
            const pct = (done / total) * 100;
            
            document.getElementById('uProgress').style.width = `${pct}%`;

            if (done >= total) {
                const mainBtn = document.getElementById('uUnlockBtn');
                mainBtn.className = "block w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 text-white font-bold py-4 rounded-lg text-center shadow-lg transform hover:-translate-y-1 transition-all duration-300 animate-pulse";
                mainBtn.innerHTML = `<i class="fa-solid fa-unlock mr-2"></i> TRUY CẬP LINK GỐC`;
                mainBtn.href = currentLinkData.destUrl;
                mainBtn.target = "_blank";
                mainBtn.onclick = null; // Remove preventDefault
            }
        }

    </script>
</body>
</html>
